<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </head>
    <body>

        <form id="envioArquivos" >
            <label for="disciplinas">Arquivo json de disciplinas:</label><br>
            <input type="file" id="disciplinas" name="disciplinas"><br><br>

            <label for="docentes">Arquivo json de docentes:</label><br>
            <input type="file" id="docentes" name="docentes"><br><br>

            <input type="submit" value="Submit">
        </form>

        <button onclick="optimize()">Otimizar</button>

        <label for="cars">Choose a car:</label>

        <select name="docent_names" id="docent_names">
        </select> 
        <table id="tabela">
        </table>

        <style>
            table, th, td {   
                border-collapse: collapse;
                border: 1px solid black;
            }

            td {
                height: 20px;
                width: 40px;
            }

            td > p {
                margin: 0;
            }
        </style>

        <script>
            var data_table = null;
            function select_docente(aa){
                console.log(aa.target.value)
                clear_table()
                show_docent_diciplins(aa.target.value, data_table);

            }

            function show_docent_diciplins(docent_name, docents){
                var tabela = document.getElementById("tabela");
                var i = 0;

                while(i < docents.length && docents[i]["nome"] != docent_name){
                    i++;
                }

                if(i < docents.length){
                    var disci_dados = docents[i]["disciplinas_dados"]
                    for(var j = 0; j < disci_dados.length; j++){
                        var horarios = disci_dados[j]["horarios"]
                        for(var k = 0; k < horarios.length; k++){
                            pos_hora_inicio = parseInt(horarios[k]["hora_inicio"].split(':')) - 6;
                            pos_hora_fim = parseInt(horarios[k]["hora_fim"].split(':')) - 6;
                            pos_dia = horarios[k]["dia_semana"];
                            innerHTML = "<p>" + docents[i]["disciplinas"][j] + "</p>";
                            for(var a = pos_hora_inicio; a <= pos_hora_fim; a++){
                                tabela.getElementsByTagName("tr")[a].getElementsByTagName("td")[pos_dia].innerHTML = innerHTML
                            }
                        }
                    }

                }
            }

            function put_names_in_select(docent){
                var select = document.getElementById("docent_names")
                docent.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element["nome"];
                    opt.innerHTML = element["nome"];
                    opt.addEventListener("click", select_docente);
                    select.appendChild(opt);
                });
            }

            function optimize(){
                $.ajax({
                    type: "POST",
                    url: "optimize",
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // Handle the response from the server
                        console.log(response);
                        get_data_table();
                    },
                    error: function(xhr, status, error) {
                        // Handle any errors that occur during the request
                        console.error(error);
                    }
                });
            }
            
            function clear_table(){
                var tabela = document.getElementById("tabela");

                for(var i=1; i<17; i++){
                    var row = tabela.getElementsByTagName("tr")[i];

                    for(var j=1; j<7; j++){
                        row.getElementsByTagName("td")[j].innerHTML = "";
                    }
                }
            }

            function create_table(){
                var tabela = document.getElementById("tabela");

                semana = ["", "segunda", "terÃ§a", "quarta", "quinta", "sexta", "sabado"]
                var head = tabela.createTHead();
                var row = head.insertRow(0);
                
                for(var j=0; j<7; j++){
                    row.insertCell(j).innerHTML = semana[j];
                }

                for(var i=1; i<17; i++){
                    row = tabela.insertRow(i);
                    row.insertCell(0).innerHTML=i+6;

                    for(var j=1; j<7; j++){
                        row.insertCell(j);
                    }
                }

                get_data_table();
            }
            
            function get_data_table(){
                $.ajax({
                    url: "docentes-info",
                    dataType: "json",
                    success: function(data) {
                        data_table = data;
                        put_names_in_select(data_table);

                    },
                    error: function(xhr, status, error) {
                        window.alert(xhr.responseText)
                    }
                });
            }

            $(document).ready(function() {

                create_table();

                $('#envioArquivos').submit(function(e) {
                    e.preventDefault(); 
                    var data = new FormData($(this)[0]); 
                    console.log(data)

                    $.ajax({
                        type: "POST",
                        url: "upload",
                        data: data,
                        processData: false,
                        contentType: false,

                        dataType: 'json',
                        success: function(response) {
                            console.log(response);
                        },
                        error: function(xhr, status, error) {
                            console.error(error);
                        }
                    });
                    
                });

            });
              
              
        </script>
    </body>
</html>